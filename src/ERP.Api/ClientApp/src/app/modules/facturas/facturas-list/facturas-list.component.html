<form [formGroup]="form">
  <h4>Facturas</h4>
  <mat-form-field>
    <mat-label>Seleccionar Periodo</mat-label>
    <mat-select [formControl]="periodoControl" name="periodo" (selectionChange)="onPeriodoChange($event)">
      <mat-option>None</mat-option>
      @for (periodo of periodos; track periodo) {
        <mat-option [value]="periodo.value">{{periodo.viewValue}}</mat-option>
      }
    </mat-select>
  </mat-form-field>


  <!-- <h4>{{ periodoControl.value}}</h4> -->
  </form>

<div class="mat-elevation-z8">
    <table mat-table [dataSource]="this.facturas" multiTemplateDataRows class="mat-elevation-z8">
      <!-- Columnas principales -->
      <ng-container matColumnDef="folio">
        <th mat-header-cell *matHeaderCellDef> Folio </th>
        <td mat-cell *matCellDef="let element"> {{element.serie }} {{element.folio}}  </td>
      </ng-container>

         <!-- Columna Fecha -->
    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef>Fecha</th>
      <td mat-cell *matCellDef="let element">{{ element.fecha | date: 'dd/MM/yyyy' }}</td>
    </ng-container>
  
      <ng-container matColumnDef="cliente">
        <th mat-header-cell *matHeaderCellDef> Cliente </th>
        <td mat-cell *matCellDef="let element"> {{element.cliente}} </td>
      </ng-container>
  
      <ng-container matColumnDef="total">
        <th mat-header-cell *matHeaderCellDef> Total </th>
        <td mat-cell *matCellDef="let element"> {{element.total  | currency }} </td>
      </ng-container>

      <ng-container matColumnDef="agente">
        <th mat-header-cell *matHeaderCellDef> Agente </th>
        <td mat-cell *matCellDef="let element"> {{element.agente}} </td>
      </ng-container>
  
      <ng-container matColumnDef="opciones">
        <th mat-header-cell *matHeaderCellDef> Opciones </th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button (click)="expandElement(element)">
            <mat-icon>{{element.expanded ? 'expand_less' : 'expand_more'}}</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Columnas de detalles -->
      <ng-container matColumnDef="detalles">
        <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
          <div class="example-element-detail" *ngIf="element.expanded">
            <table mat-table [dataSource]="element.movimientos">

              <ng-container matColumnDef="codigo">
                <th mat-header-cell *matHeaderCellDef> Codigo </th>
                <td mat-cell *matCellDef="let movimiento"> {{movimiento.codigoProducto }} </td>
              </ng-container>
  
              <ng-container matColumnDef="descripcion">
                <th mat-header-cell *matHeaderCellDef> Descripcion </th>
                <td mat-cell *matCellDef="let movimiento"> {{movimiento.descripcion}} </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['codigo', 'descripcion']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['codigo', 'descripcion'];"></tr>
            </table>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="subDetalles">
        <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
          <div class="example-element-detail" *ngIf="element.expanded">
            <table mat-table [dataSource]="element.movimientos">

              <ng-container matColumnDef="neto">
                <th mat-header-cell *matHeaderCellDef> Neto </th>
                <td mat-cell *matCellDef="let movimiento"> {{movimiento.neto  | currency}} </td>
              </ng-container>

              <ng-container matColumnDef="descto">
                <th mat-header-cell *matHeaderCellDef> Descto </th>
                <td mat-cell *matCellDef="let movimiento"> {{movimiento.descuento  | currency}} </td>
              </ng-container>
  
              <ng-container matColumnDef="IVA">
                <th mat-header-cell *matHeaderCellDef> IVA </th>
                <td mat-cell *matCellDef="let movimiento"> {{movimiento.impuesto  | currency}} </td>
              </ng-container>
  
              <ng-container matColumnDef="ISR">
                <th mat-header-cell *matHeaderCellDef> ISR </th>
                <td mat-cell *matCellDef="let movimiento"> {{movimiento.retencion  | currency}} </td>
              </ng-container>

              <!-- El orden que importa esta en Tr estos container no indican orden-->
              <ng-container matColumnDef="Agente">
                <th mat-header-cell *matHeaderCellDef> Agente </th>
                <td mat-cell *matCellDef="let movimiento"><input class="short-input" [formControl]="$any(movimientoForm).get('idAgente')" maxlength="1"/> </td>
              </ng-container>
  
  
              <ng-container matColumnDef="Com">
                <th mat-header-cell *matHeaderCellDef>% Com </th>
                <td mat-cell *matCellDef="let movimiento"> <input class="short-input"  [formControl]="$any(movimientoForm).get('comision')"  maxlength="3"  /></td>
              </ng-container>

              <ng-container matColumnDef="Uti">
                <th mat-header-cell *matHeaderCellDef> Utilidad </th>
                <td mat-cell *matCellDef="let movimiento">   
                   <app-currency-input class="short-input"  [control]="movimientoForm.get('utilidad')"></app-currency-input>
                   
                  </td>
              </ng-container>
  
         
              <ng-container matColumnDef="U.Ric">
                <th mat-header-cell *matHeaderCellDef> U Ric </th>
                <td mat-cell *matCellDef="let movimiento">
                  <app-currency-input [control]="$any(movimientoForm).get('utilidadRicardo')"></app-currency-input>
                   <!-- <input class="short-input" [formControl]="$any(movimientoForm).get('utilidadRicardo')"/> </td> -->
              </ng-container>

              <ng-container matColumnDef="U.Ang">
                <th mat-header-cell *matHeaderCellDef> U Angie </th>
                <td mat-cell *matCellDef="let movimiento"> <app-currency-input [control]="movimientoForm.get('utilidadAngie')"></app-currency-input></td>
              </ng-container>

              <ng-container matColumnDef="IvaR">
                <th mat-header-cell *matHeaderCellDef> IVA Ric </th>
                <td mat-cell *matCellDef="let movimiento"> <app-currency-input [control]="movimientoForm.get('ivaRicardo')"></app-currency-input> </td>
              </ng-container>

              <ng-container matColumnDef="IvaA">
                <th mat-header-cell *matHeaderCellDef> IVA Angie </th>
                <td mat-cell *matCellDef="let movimiento"><app-currency-input [control]="movimientoForm.get('ivaAngie')"></app-currency-input> </td>
              </ng-container>

              <ng-container matColumnDef="IsrR">
                <th mat-header-cell *matHeaderCellDef> ISR Ric </th>
                <td mat-cell *matCellDef="let movimiento"> <app-currency-input [control]="movimientoForm.get('isrRicardo')"></app-currency-input></td>
              </ng-container>

              <ng-container matColumnDef="IsrA">
                <th mat-header-cell *matHeaderCellDef> ISR Angie </th>
                <td mat-cell *matCellDef="let movimiento"><app-currency-input [control]="movimientoForm.get('isrAngie')"></app-currency-input> </td>
              </ng-container>

              <ng-container matColumnDef="Observa">
                <th mat-header-cell *matHeaderCellDef> Observa. </th>
                <td mat-cell *matCellDef="let movimiento"><input class="medium-input"  [formControl]="$any(movimientoForm).get('observaciones')"/> </td>
              </ng-container>


              
              <ng-container matColumnDef="save">
                <th mat-header-cell *matHeaderCellDef>Opciones </th>
                <td mat-cell *matCellDef="let movimiento"> 

                <button  mat-icon-button matTooltip="calc comision" matTooltipPosition="left" aria-label="calcular" class="calulate-icon" (click)="calcularImportes()">
                    <mat-icon>calculate</mat-icon>
                </button>
                  <button  mat-icon-button aria-label="save" class="save-icon" (click)="updateMovimiento(movimiento)">
                    <mat-icon>save</mat-icon>
                </button>
                </td>
              </ng-container>
           
              <tr mat-header-row *matHeaderRowDef="['neto', 'descto', 'IVA', 'ISR', 'Agente', 'Com', 'Uti',  'U.Ric', 'U.Ang', 'IvaR', 'IvaA', 'IsrR', 'IsrA','Observa','save']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['neto', 'descto', 'IVA', 'ISR', 'Agente', 'Com', 'Uti',  'U.Ric', 'U.Ang', 'IvaR', 'IvaA', 'IsrR', 'IsrA','Observa','save'];"></tr>
            </table>
          </div>
        </td>
      </ng-container>

   
  
      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr mat-row *matRowDef="let element; columns: columnsToDisplay;" class="example-element-row"
        [class.example-expanded-row]="element.expanded">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['detalles']" class="example-detail-row"></tr>
      <tr mat-row *matRowDef="let row; columns: ['subDetalles']" class="example-detail-row"></tr>




    </table>
  </div>